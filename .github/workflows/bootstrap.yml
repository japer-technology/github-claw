name: Bootstrap GITCLAW

on:
  workflow_dispatch:
    inputs:
      overwrite:
        description: "Overwrite existing files (default: false)"
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
    paths:
      - ".GITCLAW/workflows/**"
      - ".GITCLAW/gitignore"
      - ".GITCLAW/.gitignore"
      - ".GITCLAW/files/**"
      - ".GITCLAW/issue-templates/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap GITCLAW files
        id: install
        env:
          OVERWRITE: ${{ inputs.overwrite || 'false' }}
        run: |
          set -euo pipefail
          CHANGED=false

          # ── 1. Install workflows ─────────────────────────────────────

          if [ -d .GITCLAW/workflows ]; then
            mkdir -p .github/workflows
            for src in .GITCLAW/workflows/*.yml; do
              [ -f "$src" ] || continue
              base="$(basename "$src")"
              dest=".github/workflows/$base"

              # Never overwrite the install workflow itself
              if [ "$base" = "install.yml" ]; then
                echo "⏭  Skipping $base (self)"
                continue
              fi

              if [ -f "$dest" ] && [ "$OVERWRITE" != "true" ]; then
                echo "⏭  $dest already exists — skipping (set overwrite to replace)"
                continue
              fi

              cp "$src" "$dest"
              echo "✅ Installed $dest"
              CHANGED=true
            done
          fi

          # ── 2. Merge .gitignore rules ──────────────────────────────

          GITIGNORE_SRC=""
          [ -f .GITCLAW/gitignore ]  && GITIGNORE_SRC=".GITCLAW/gitignore"
          [ -f .GITCLAW/.gitignore ] && GITIGNORE_SRC=".GITCLAW/.gitignore"

          if [ -n "$GITIGNORE_SRC" ]; then
            MARKER="# ── GITCLAW bootstrap ──"
            if [ -f .gitignore ] && grep -qF "$MARKER" .gitignore; then
              echo "⏭  .gitignore already contains GITCLAW section"
            else
              { echo ""; echo "$MARKER"; cat "$GITIGNORE_SRC"; } >> .gitignore
              echo "✅ Appended $GITIGNORE_SRC to .gitignore"
              CHANGED=true
            fi
          fi

          # ── 3. Copy extra files from .GITCLAW/files/ ───────────────

          if [ -d .GITCLAW/files ]; then
            while IFS= read -r -d '' src; do
              rel="${src#.GITCLAW/files/}"
              mkdir -p "$(dirname "$rel")"
              if [ -f "$rel" ] && [ "$OVERWRITE" != "true" ]; then
                echo "⏭  $rel already exists — skipping"
                continue
              fi
              cp "$src" "$rel"
              echo "✅ Installed $rel"
              CHANGED=true
            done < <(find .GITCLAW/files -type f -print0)
          fi

          # ── 4. Install issue templates ─────────────────────────────

          if [ -d .GITCLAW/issue-templates ]; then
            mkdir -p .github/ISSUE_TEMPLATE
            for src in .GITCLAW/issue-templates/*; do
              [ -f "$src" ] || continue
              dest=".github/ISSUE_TEMPLATE/$(basename "$src")"
              if [ -f "$dest" ] && [ "$OVERWRITE" != "true" ]; then
                echo "⏭  $dest already exists — skipping"
                continue
              fi
              cp "$src" "$dest"
              echo "✅ Installed $dest"
              CHANGED=true
            done
          fi

          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.install.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: install GITCLAW workflows and config"
          branch: gitclaw/bootstrap
          title: "chore: install GITCLAW workflows and config"
          body: |
            Automated PR created by the **GITCLAW bootstrap** workflow.

            ### Changes
            - Installed workflow files from `.GITCLAW/workflows/` → `.github/workflows/`
            - Merged `.gitignore` rules (if source existed)
            - Copied extra files from `.GITCLAW/files/` (if present)
            - Installed issue templates from `.GITCLAW/issue-templates/`

            > Merge this PR to activate the installed workflows.
          delete-branch: true

      - name: Summary
        if: steps.install.outputs.changed != 'true'
        run: echo "ℹ️  Nothing to install — all files are already up to date."
